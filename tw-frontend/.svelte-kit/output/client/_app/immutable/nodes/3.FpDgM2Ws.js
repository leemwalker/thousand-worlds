var Wt=Object.defineProperty;var Ut=(i,e,t)=>e in i?Wt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var le=(i,e,t)=>Ut(i,typeof e!="symbol"?e+"":e,t);import{r as je,s as Ce,n as ge,d as b,i as re,e as c,l as ae,c as u,f as g,g as x,h as J,j as D,m as v,o as I,Z as Ke,_ as Ne,a as de,k as te,t as se,B as Ye,x as at,u as Rt,q as tt,$ as st,D as ot,a0 as Qt,M as Xt,C as Nt,b as Ge,a1 as Se,z as Yt,E as ct,F as dt,a2 as Gt,a3 as Jt}from"../chunks/CNXArMli.js";import{a as he,S as Ee,i as Te,t as pe,g as Ae,c as Re,f as ut,d as Ie,m as ze,e as Me,b as Ve}from"../chunks/BWH_Fj_B.js";import{g as ht}from"../chunks/BZrBSvfc.js";import{a as De,m as Je,g as Ue}from"../chunks/DyiKixLh.js";import{w as $e}from"../chunks/B0GIxsE8.js";import{a as ft}from"../chunks/CVTDIfUj.js";function ye(i){return(i==null?void 0:i.length)!==void 0?i:Array.from(i)}function Kt(i,e){i.d(1),e.delete(i.key)}function Zt(i,e,t,s,n,l,r,a,o,h,d,f){let m=i.length,S=l.length,w=m;const C={};for(;w--;)C[i[w].key]=w;const M=[],E=new Map,p=new Map,P=[];for(w=S;w--;){const T=f(n,l,w),N=t(T);let L=r.get(N);L?P.push(()=>L.p(T,e)):(L=h(N,T),L.c()),E.set(N,M[w]=L),N in C&&p.set(N,Math.abs(w-C[N]))}const z=new Set,k=new Set;function U(T){he(T,1),T.m(a,d),r.set(T.key,T),d=T.first,S--}for(;m&&S;){const T=M[S-1],N=i[m-1],L=T.key,F=N.key;T===N?(d=T.first,m--,S--):E.has(F)?!r.has(L)||z.has(L)?U(T):k.has(F)?m--:p.get(L)>p.get(F)?(k.add(L),U(T)):(z.add(F),m--):(o(N,r),m--)}for(;m--;){const T=i[m];E.has(T.key)||o(T,r)}for(;S;)U(M[S-1]);return je(P),M}const $t="mud-command-queue",es=1,be="commands",ts=3;class ss{constructor(){le(this,"db",null);le(this,"isProcessing",!1)}async init(){return new Promise((e,t)=>{const s=indexedDB.open($t,es);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=n=>{const l=n.target.result;if(!l.objectStoreNames.contains(be)){const r=l.createObjectStore(be,{keyPath:"id"});r.createIndex("status","status",{unique:!1}),r.createIndex("timestamp","timestamp",{unique:!1})}}})}async enqueue(e){if(!this.db)throw new Error("Database not initialized");const t={id:crypto.randomUUID(),text:e,timestamp:Date.now(),retryCount:0,status:"pending"};return new Promise((s,n)=>{const a=this.db.transaction([be],"readwrite").objectStore(be).add(t);a.onsuccess=()=>s(t.id),a.onerror=()=>n(a.error)})}async getPending(){return this.db?new Promise((e,t)=>{const r=this.db.transaction([be],"readonly").objectStore(be).index("status").getAll("pending");r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}):[]}async getPendingCount(){return this.db?new Promise((e,t)=>{const r=this.db.transaction([be],"readonly").objectStore(be).index("status").count("pending");r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}):0}async processQueue(e){if(!(!this.db||this.isProcessing)){this.isProcessing=!0;try{const t=await this.getPending();for(const s of t){await this.updateStatus(s.id,"processing");try{await e(s.text),await this.remove(s.id)}catch(n){console.error("Failed to send queued command:",n),s.retryCount<ts?await this.incrementRetry(s.id):await this.updateStatus(s.id,"failed")}}}finally{this.isProcessing=!1}}}async clearFailed(){if(this.db)return new Promise((e,t)=>{const r=this.db.transaction([be],"readwrite").objectStore(be).index("status").openCursor(IDBKeyRange.only("failed"));r.onsuccess=a=>{const o=a.target.result;o?(o.delete(),o.continue()):e()},r.onerror=()=>t(r.error)})}async updateStatus(e,t){if(this.db)return new Promise((s,n)=>{const r=this.db.transaction([be],"readwrite").objectStore(be),a=r.get(e);a.onsuccess=()=>{const o=a.result;if(o){o.status=t;const h=r.put(o);h.onsuccess=()=>s(),h.onerror=()=>n(h.error)}else s()},a.onerror=()=>n(a.error)})}async incrementRetry(e){if(this.db)return new Promise((t,s)=>{const l=this.db.transaction([be],"readwrite").objectStore(be),r=l.get(e);r.onsuccess=()=>{const a=r.result;if(a){a.retryCount++,a.status="pending";const o=l.put(a);o.onsuccess=()=>t(),o.onerror=()=>s(o.error)}else t()},r.onerror=()=>s(r.error)})}async remove(e){if(this.db)return new Promise((t,s)=>{const r=this.db.transaction([be],"readwrite").objectStore(be).delete(e);r.onsuccess=()=>t(),r.onerror=()=>s(r.error)})}close(){this.db&&(this.db.close(),this.db=null)}}const Ze=new ss;class rs{constructor(){le(this,"ws",null);le(this,"reconnectAttempts",0);le(this,"maxReconnectAttempts",5);le(this,"reconnectDelay",1e3);le(this,"currentCharacterId");le(this,"isIntentionalDisconnect",!1);le(this,"connected",$e(!1));le(this,"pendingCommands",$e(0));le(this,"messageHandlers",new Set)}connect(e){console.log("[WebSocket] Attempting to connect...",{characterId:e}),this.isIntentionalDisconnect=!1,e&&(this.currentCharacterId=e);const t=window.location.protocol==="https:"?"wss:":"ws:",s=window.location.hostname,n=window.location.port,l=n==="5173"?`${s}:${n}`:`${s}:8080`;let r=`${t}//${l}/api/game/ws`;this.currentCharacterId&&(r+=`?character_id=${encodeURIComponent(this.currentCharacterId)}`),console.log("[WebSocket] URL:",r);try{this.ws=new WebSocket(r),this.ws.onopen=()=>{console.log("[WebSocket] Connection opened!"),this.connected.set(!0),this.reconnectAttempts=0,De.setLoading(!1),this.processQueuedCommands()},this.ws.onmessage=a=>{try{const h=a.data.toString().split(`
`).filter(d=>d.trim()!=="");for(const d of h)try{const f=JSON.parse(d);this.handleMessage(f)}catch(f){console.error("[WebSocket] Failed to parse message part:",f)}}catch(o){console.error("[WebSocket] Failed to process message:",o)}},this.ws.onerror=a=>{console.error("[WebSocket] Error:",a),De.setError("Connection error")},this.ws.onclose=()=>{console.log("[WebSocket] Connection closed"),this.connected.set(!1),this.isIntentionalDisconnect||this.attemptReconnect()}}catch(a){console.error("[WebSocket] Failed to create WebSocket:",a),De.setError("Failed to create connection")}}disconnect(){this.isIntentionalDisconnect=!0,this.ws&&(this.ws.close(),this.ws=null),this.connected.set(!1)}sendRawCommand(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.error("WebSocket not connected");return}const t={type:"command",data:{text:e}};this.ws.send(JSON.stringify(t))}async sendCommandWithQueue(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){await Ze.enqueue(e),await this.updatePendingCount(),console.log("Command queued for later sending");return}this.sendRawCommand(e)}async processQueuedCommands(){try{await Ze.processQueue(async e=>new Promise((t,s)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){s(new Error("WebSocket not connected"));return}const n={type:"command",data:{text:e}};this.ws.send(JSON.stringify(n)),t()})),await this.updatePendingCount()}catch(e){console.error("Error processing queued commands:",e)}}async updatePendingCount(){const e=await Ze.getPendingCount();this.pendingCommands.set(e)}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}handleMessage(e){var t;if(e.type==="map_update"){const s=this.mapBackendToFrontend(e.data);Je.setMapData(s)}else if(e.type==="game_message"){const s=e;if((t=s.data)!=null&&t.metadata&&s.data.type==="map_update"){const n=this.mapBackendToFrontend(s.data.metadata);Je.setMapData(n)}De.addMessage({type:"game_message",timestamp:e.timestamp||Date.now(),content:s.data.content,sender:s.data.sender,channel:s.data.channel})}else e.type==="state_update"&&(De.updateStats(e.data.stats||{}),e.data.inventory&&De.setInventory(e.data.inventory));this.messageHandlers.forEach(s=>{try{s(e)}catch(n){console.error("Message handler error:",n)}})}mapBackendToFrontend(e){return e&&Array.isArray(e.tiles)?e:e&&Array.isArray(e.cells)?{...e,tiles:e.cells.map(t=>({x:t.q,y:t.r,biome:t.biome_type||"Default",elevation:t.elevation||0,occluded:t.occluded,is_player:t.is_player,entities:t.entities,portal:t.portal}))}:e}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnect attempts reached"),De.setError("Connection lost. Please refresh.");return}this.reconnectAttempts++;const e=this.reconnectDelay*.2*(Math.random()-.5),t=this.reconnectDelay*this.reconnectAttempts+e;console.log(`Reconnecting in ${Math.round(t)}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect(this.currentCharacterId)},t)}}const ke=new rs;function gt(i,e,t){const s=i.slice();return s[7]=e[t],s}function vt(i){let e,t=`<div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold text-gray-200 group-hover:text-blue-300">Watcher</h3> <span class="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-500/30">Invisible</span></div> <p class="text-gray-400 text-sm">Enter as an invisible observer. You can explore freely
                        without stamina cost, but cannot interact with the
                        world.</p>`,s,n;return{c(){e=v("button"),e.innerHTML=t,this.h()},l(l){e=g(l,"BUTTON",{class:!0,"data-testid":!0,"data-svelte-h":!0}),J(e)!=="svelte-fazf1p"&&(e.innerHTML=t),this.h()},h(){u(e,"class","p-4 border border-gray-700 hover:border-blue-400 hover:bg-blue-900/20 rounded text-left transition-all group"),u(e,"data-testid","entry-option-watcher")},m(l,r){re(l,e,r),s||(n=ae(e,"click",i[2]),s=!0)},p:ge,d(l){l&&b(e),s=!1,n()}}}function mt(i){let e,t,s='<h3 class="text-lg font-bold text-gray-200">Inhabit Existing NPC</h3> <span class="text-xs text-gray-500">Select a life to take over</span>',n,l,r=ye(i[0].available_npcs),a=[];for(let o=0;o<r.length;o+=1)a[o]=pt(gt(i,r,o));return{c(){e=v("div"),t=v("div"),t.innerHTML=s,n=I(),l=v("div");for(let o=0;o<a.length;o+=1)a[o].c();this.h()},l(o){e=g(o,"DIV",{class:!0});var h=x(e);t=g(h,"DIV",{class:!0,"data-svelte-h":!0}),J(t)!=="svelte-11j9379"&&(t.innerHTML=s),n=D(h),l=g(h,"DIV",{class:!0});var d=x(l);for(let f=0;f<a.length;f+=1)a[f].l(d);d.forEach(b),h.forEach(b),this.h()},h(){u(t,"class","flex items-center justify-between"),u(l,"class","grid grid-cols-1 md:grid-cols-2 gap-3"),u(e,"class","space-y-3")},m(o,h){re(o,e,h),c(e,t),c(e,n),c(e,l);for(let d=0;d<a.length;d+=1)a[d]&&a[d].m(l,null)},p(o,h){if(h&3){r=ye(o[0].available_npcs);let d;for(d=0;d<r.length;d+=1){const f=gt(o,r,d);a[d]?a[d].p(f,h):(a[d]=pt(f),a[d].c(),a[d].m(l,null))}for(;d<a.length;d+=1)a[d].d(1);a.length=r.length}},d(o){o&&b(e),Ne(a,o)}}}function pt(i){let e,t,s=i[7].name+"",n,l,r,a=i[7].species+"",o,h,d=i[7].occupation+"",f,m,S,w=i[7].description+"",C,M,E,p;function P(){return i[3](i[7])}return{c(){e=v("button"),t=v("div"),n=se(s),l=I(),r=v("div"),o=se(a),h=se(" â€¢ "),f=se(d),m=I(),S=v("div"),C=se(w),M=I(),this.h()},l(z){e=g(z,"BUTTON",{class:!0,"data-testid":!0});var k=x(e);t=g(k,"DIV",{class:!0});var U=x(t);n=te(U,s),U.forEach(b),l=D(k),r=g(k,"DIV",{class:!0});var T=x(r);o=te(T,a),h=te(T," â€¢ "),f=te(T,d),T.forEach(b),m=D(k),S=g(k,"DIV",{class:!0});var N=x(S);C=te(N,w),N.forEach(b),M=D(k),k.forEach(b),this.h()},h(){u(t,"class","font-bold text-green-300 group-hover:text-green-200 mb-1"),u(r,"class","text-xs text-gray-400 mb-2 font-mono"),u(S,"class","text-xs text-gray-500 flex-1"),u(e,"class","p-3 border border-gray-700 hover:border-green-400 hover:bg-green-900/20 rounded text-left transition-all group h-full flex flex-col"),u(e,"data-testid","entry-option-npc")},m(z,k){re(z,e,k),c(e,t),c(t,n),c(e,l),c(e,r),c(r,o),c(r,h),c(r,f),c(e,m),c(e,S),c(S,C),c(e,M),E||(p=ae(e,"click",P),E=!0)},p(z,k){i=z,k&1&&s!==(s=i[7].name+"")&&de(n,s),k&1&&a!==(a=i[7].species+"")&&de(o,a),k&1&&d!==(d=i[7].occupation+"")&&de(f,d),k&1&&w!==(w=i[7].description+"")&&de(C,w)},d(z){z&&b(e),E=!1,p()}}}function bt(i){let e,t=`<div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold text-gray-200 group-hover:text-purple-300">Create New Character</h3> <span class="text-xs bg-purple-900/50 text-purple-300 px-2 py-1 rounded border border-purple-500/30">Custom</span></div> <p class="text-gray-400 text-sm">Design your own character from scratch. Choose your
                        species, name, and attributes.</p>`,s,n;return{c(){e=v("button"),e.innerHTML=t,this.h()},l(l){e=g(l,"BUTTON",{class:!0,"data-testid":!0,"data-svelte-h":!0}),J(e)!=="svelte-1pjs6al"&&(e.innerHTML=t),this.h()},h(){u(e,"class","p-4 border border-gray-700 hover:border-purple-400 hover:bg-purple-900/20 rounded text-left transition-all group"),u(e,"data-testid","entry-option-custom")},m(l,r){re(l,e,r),s||(n=ae(e,"click",i[4]),s=!0)},p:ge,d(l){l&&b(e),s=!1,n()}}}function is(i){let e,t,s,n="Choose Your Path",l,r,a,o,h,d,f,m="Cancel",S,w,C=i[0].can_enter_as_watcher&&vt(i),M=i[0].available_npcs&&i[0].available_npcs.length>0&&mt(i),E=i[0].can_create_custom&&bt(i);return{c(){e=v("div"),t=v("div"),s=v("h2"),s.textContent=n,l=I(),r=v("div"),C&&C.c(),a=I(),M&&M.c(),o=I(),E&&E.c(),h=I(),d=v("div"),f=v("button"),f.textContent=m,this.h()},l(p){e=g(p,"DIV",{class:!0});var P=x(e);t=g(P,"DIV",{class:!0});var z=x(t);s=g(z,"H2",{class:!0,"data-svelte-h":!0}),J(s)!=="svelte-1p3hd72"&&(s.textContent=n),l=D(z),r=g(z,"DIV",{class:!0});var k=x(r);C&&C.l(k),a=D(k),M&&M.l(k),o=D(k),E&&E.l(k),k.forEach(b),h=D(z),d=g(z,"DIV",{class:!0});var U=x(d);f=g(U,"BUTTON",{class:!0,"data-svelte-h":!0}),J(f)!=="svelte-1087po9"&&(f.textContent=m),U.forEach(b),z.forEach(b),P.forEach(b),this.h()},h(){u(s,"class","text-2xl font-bold text-blue-400 mb-6 text-center font-mono uppercase tracking-widest"),u(r,"class","grid gap-6"),u(f,"class","text-gray-500 hover:text-gray-300 text-sm underline"),u(d,"class","mt-6 text-center"),u(t,"class","bg-gray-900 border border-blue-500/50 p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto"),u(e,"class","fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4")},m(p,P){re(p,e,P),c(e,t),c(t,s),c(t,l),c(t,r),C&&C.m(r,null),c(r,a),M&&M.m(r,null),c(r,o),E&&E.m(r,null),c(t,h),c(t,d),c(d,f),S||(w=ae(f,"click",i[5]),S=!0)},p(p,[P]){p[0].can_enter_as_watcher?C?C.p(p,P):(C=vt(p),C.c(),C.m(r,a)):C&&(C.d(1),C=null),p[0].available_npcs&&p[0].available_npcs.length>0?M?M.p(p,P):(M=mt(p),M.c(),M.m(r,o)):M&&(M.d(1),M=null),p[0].can_create_custom?E?E.p(p,P):(E=bt(p),E.c(),E.m(r,null)):E&&(E.d(1),E=null)},i:ge,o:ge,d(p){p&&b(e),C&&C.d(),M&&M.d(),E&&E.d(),S=!1,w()}}}function ns(i,e,t){let{options:s}=e;const n=Ke();function l(d,f){n("select",{type:d,data:f})}const r=()=>l("watcher"),a=d=>l("npc",d),o=()=>l("custom"),h=()=>l("cancel");return i.$$set=d=>{"options"in d&&t(0,s=d.options)},[s,l,r,a,o,h]}class ls extends Ee{constructor(e){super(),Te(this,e,ns,is,Ce,{options:0})}}function yt(i,e,t){const s=i.slice();return s[15]=e[t],s}function _t(i){let e,t,s="Attributes",n,l,r,a,o="Strength",h,d,f,m,S,w,C="Dexterity",M,E,p,P,z,k,U="Constitution",T,N,L,F,oe,K,ie="Intelligence",$,H,ve,A,Q,G,ne="Wisdom",X,j,ee,Z,Y,q,O="Charisma",V,W,ue;return{c(){e=v("div"),t=v("h3"),t.textContent=s,n=I(),l=v("div"),r=v("div"),a=v("div"),a.textContent=o,h=I(),d=v("div"),f=se(i[4]),m=I(),S=v("div"),w=v("div"),w.textContent=C,M=I(),E=v("div"),p=se(i[5]),P=I(),z=v("div"),k=v("div"),k.textContent=U,T=I(),N=v("div"),L=se(i[6]),F=I(),oe=v("div"),K=v("div"),K.textContent=ie,$=I(),H=v("div"),ve=se(i[7]),A=I(),Q=v("div"),G=v("div"),G.textContent=ne,X=I(),j=v("div"),ee=se(i[8]),Z=I(),Y=v("div"),q=v("div"),q.textContent=O,V=I(),W=v("div"),ue=se(i[9]),this.h()},l(y){e=g(y,"DIV",{});var _=x(e);t=g(_,"H3",{class:!0,"data-svelte-h":!0}),J(t)!=="svelte-997l6d"&&(t.textContent=s),n=D(_),l=g(_,"DIV",{class:!0});var B=x(l);r=g(B,"DIV",{class:!0});var R=x(r);a=g(R,"DIV",{class:!0,"data-svelte-h":!0}),J(a)!=="svelte-15on3nb"&&(a.textContent=o),h=D(R),d=g(R,"DIV",{class:!0});var ce=x(d);f=te(ce,i[4]),ce.forEach(b),R.forEach(b),m=D(B),S=g(B,"DIV",{class:!0});var me=x(S);w=g(me,"DIV",{class:!0,"data-svelte-h":!0}),J(w)!=="svelte-qkib5i"&&(w.textContent=C),M=D(me),E=g(me,"DIV",{class:!0});var _e=x(E);p=te(_e,i[5]),_e.forEach(b),me.forEach(b),P=D(B),z=g(B,"DIV",{class:!0});var we=x(z);k=g(we,"DIV",{class:!0,"data-svelte-h":!0}),J(k)!=="svelte-r3xn11"&&(k.textContent=U),T=D(we),N=g(we,"DIV",{class:!0});var qe=x(N);L=te(qe,i[6]),qe.forEach(b),we.forEach(b),F=D(B),oe=g(B,"DIV",{class:!0});var xe=x(oe);K=g(xe,"DIV",{class:!0,"data-svelte-h":!0}),J(K)!=="svelte-11y7hwx"&&(K.textContent=ie),$=D(xe),H=g(xe,"DIV",{class:!0});var Pe=x(H);ve=te(Pe,i[7]),Pe.forEach(b),xe.forEach(b),A=D(B),Q=g(B,"DIV",{class:!0});var He=x(Q);G=g(He,"DIV",{class:!0,"data-svelte-h":!0}),J(G)!=="svelte-simxrd"&&(G.textContent=ne),X=D(He),j=g(He,"DIV",{class:!0});var nt=x(j);ee=te(nt,i[8]),nt.forEach(b),He.forEach(b),Z=D(B),Y=g(B,"DIV",{class:!0});var We=x(Y);q=g(We,"DIV",{class:!0,"data-svelte-h":!0}),J(q)!=="svelte-141kacq"&&(q.textContent=O),V=D(We),W=g(We,"DIV",{class:!0});var lt=x(W);ue=te(lt,i[9]),lt.forEach(b),We.forEach(b),B.forEach(b),_.forEach(b),this.h()},h(){u(t,"class","text-lg font-bold text-gray-100 mb-2 sr-only"),u(a,"class","text-xs text-gray-400"),u(d,"class","text-xl font-bold text-red-400"),u(r,"class","bg-gray-800 rounded p-2"),u(w,"class","text-xs text-gray-400"),u(E,"class","text-xl font-bold text-green-400"),u(S,"class","bg-gray-800 rounded p-2"),u(k,"class","text-xs text-gray-400"),u(N,"class","text-xl font-bold text-orange-400"),u(z,"class","bg-gray-800 rounded p-2"),u(K,"class","text-xs text-gray-400"),u(H,"class","text-xl font-bold text-blue-400"),u(oe,"class","bg-gray-800 rounded p-2"),u(G,"class","text-xs text-gray-400"),u(j,"class","text-xl font-bold text-cyan-400"),u(Q,"class","bg-gray-800 rounded p-2"),u(q,"class","text-xs text-gray-400"),u(W,"class","text-xl font-bold text-purple-400"),u(Y,"class","bg-gray-800 rounded p-2"),u(l,"class","grid grid-cols-2 gap-2")},m(y,_){re(y,e,_),c(e,t),c(e,n),c(e,l),c(l,r),c(r,a),c(r,h),c(r,d),c(d,f),c(l,m),c(l,S),c(S,w),c(S,M),c(S,E),c(E,p),c(l,P),c(l,z),c(z,k),c(z,T),c(z,N),c(N,L),c(l,F),c(l,oe),c(oe,K),c(oe,$),c(oe,H),c(H,ve),c(l,A),c(l,Q),c(Q,G),c(Q,X),c(Q,j),c(j,ee),c(l,Z),c(l,Y),c(Y,q),c(Y,V),c(Y,W),c(W,ue)},p(y,_){_&16&&de(f,y[4]),_&32&&de(p,y[5]),_&64&&de(L,y[6]),_&128&&de(ve,y[7]),_&256&&de(ee,y[8]),_&512&&de(ue,y[9])},d(y){y&&b(e)}}}function wt(i){let e,t,s="Skills",n,l;function r(h,d){return d&1024&&(l=null),l==null&&(l=Object.keys(h[10]).length===0),l?os:as}let a=r(i,-1),o=a(i);return{c(){e=v("div"),t=v("h3"),t.textContent=s,n=I(),o.c(),this.h()},l(h){e=g(h,"DIV",{class:!0});var d=x(e);t=g(d,"H3",{class:!0,"data-svelte-h":!0}),J(t)!=="svelte-8zem0i"&&(t.textContent=s),n=D(d),o.l(d),d.forEach(b),this.h()},h(){u(t,"class","text-lg font-bold text-gray-100 mb-2 sr-only"),u(e,"class","mt-0")},m(h,d){re(h,e,d),c(e,t),c(e,n),o.m(e,null)},p(h,d){a===(a=r(h,d))&&o?o.p(h,d):(o.d(1),o=a(h),o&&(o.c(),o.m(e,null)))},d(h){h&&b(e),o.d()}}}function as(i){let e,t=ye(Object.values(i[10])),s=[];for(let n=0;n<t.length;n+=1)s[n]=xt(yt(i,t,n));return{c(){e=v("div");for(let n=0;n<s.length;n+=1)s[n].c();this.h()},l(n){e=g(n,"DIV",{class:!0});var l=x(e);for(let r=0;r<s.length;r+=1)s[r].l(l);l.forEach(b),this.h()},h(){u(e,"class","grid grid-cols-1 gap-2")},m(n,l){re(n,e,l);for(let r=0;r<s.length;r+=1)s[r]&&s[r].m(e,null)},p(n,l){if(l&1024){t=ye(Object.values(n[10]));let r;for(r=0;r<t.length;r+=1){const a=yt(n,t,r);s[r]?s[r].p(a,l):(s[r]=xt(a),s[r].c(),s[r].m(e,null))}for(;r<s.length;r+=1)s[r].d(1);s.length=t.length}},d(n){n&&b(e),Ne(s,n)}}}function os(i){let e,t="No skills learned yet.";return{c(){e=v("div"),e.textContent=t,this.h()},l(s){e=g(s,"DIV",{class:!0,"data-svelte-h":!0}),J(e)!=="svelte-1j49tet"&&(e.textContent=t),this.h()},h(){u(e,"class","text-gray-500 text-sm italic py-4 text-center")},m(s,n){re(s,e,n)},p:ge,d(s){s&&b(e)}}}function xt(i){let e,t,s,n=i[15].name+"",l,r,a,o=i[15].category+"",h,d,f,m,S,w=i[15].level+"",C,M,E,p=i[15].xp+"",P,z,k;return{c(){e=v("div"),t=v("div"),s=v("div"),l=se(n),r=I(),a=v("div"),h=se(o),d=I(),f=v("div"),m=v("div"),S=se("Level "),C=se(w),M=I(),E=v("div"),P=se(p),z=se(" XP"),k=I(),this.h()},l(U){e=g(U,"DIV",{class:!0});var T=x(e);t=g(T,"DIV",{});var N=x(t);s=g(N,"DIV",{class:!0});var L=x(s);l=te(L,n),L.forEach(b),r=D(N),a=g(N,"DIV",{class:!0});var F=x(a);h=te(F,o),F.forEach(b),N.forEach(b),d=D(T),f=g(T,"DIV",{class:!0});var oe=x(f);m=g(oe,"DIV",{class:!0});var K=x(m);S=te(K,"Level "),C=te(K,w),K.forEach(b),M=D(oe),E=g(oe,"DIV",{class:!0});var ie=x(E);P=te(ie,p),z=te(ie," XP"),ie.forEach(b),oe.forEach(b),k=D(T),T.forEach(b),this.h()},h(){u(s,"class","text-sm font-bold text-gray-200"),u(a,"class","text-xs text-gray-400"),u(m,"class","text-sm font-mono text-blue-400"),u(E,"class","text-xs text-gray-500"),u(f,"class","text-right"),u(e,"class","bg-gray-800 rounded p-2 flex justify-between items-center")},m(U,T){re(U,e,T),c(e,t),c(t,s),c(s,l),c(t,r),c(t,a),c(a,h),c(e,d),c(e,f),c(f,m),c(m,S),c(m,C),c(f,M),c(f,E),c(E,P),c(E,z),c(e,k)},p(U,T){T&1024&&n!==(n=U[15].name+"")&&de(l,n),T&1024&&o!==(o=U[15].category+"")&&de(h,o),T&1024&&w!==(w=U[15].level+"")&&de(C,w),T&1024&&p!==(p=U[15].xp+"")&&de(P,p)},d(U){U&&b(e)}}}function cs(i){let e,t,s,n,l,r,a,o,h,d,f,m,S="Experience",w,C,M,E,p,P,z,k,U,T,N,L,F,oe,K,ie,$,H,ve,A,Q,G=i[11]==="stats"&&_t(i),ne=i[11]==="skills"&&wt(i);return{c(){e=v("div"),t=v("div"),s=v("h2"),n=se(i[0]),l=I(),r=v("div"),a=se("Level "),o=se(i[1]),h=I(),d=v("div"),f=v("div"),m=v("span"),m.textContent=S,w=I(),C=v("span"),M=se(i[2]),E=se("/"),p=se(i[3]),P=I(),z=v("div"),k=v("div"),U=I(),T=v("div"),N=v("button"),L=se("Stats"),oe=I(),K=v("button"),ie=se("Skills"),H=I(),G&&G.c(),ve=I(),ne&&ne.c(),this.h()},l(X){e=g(X,"DIV",{class:!0});var j=x(e);t=g(j,"DIV",{class:!0});var ee=x(t);s=g(ee,"H2",{class:!0});var Z=x(s);n=te(Z,i[0]),Z.forEach(b),l=D(ee),r=g(ee,"DIV",{class:!0});var Y=x(r);a=te(Y,"Level "),o=te(Y,i[1]),Y.forEach(b),h=D(ee),d=g(ee,"DIV",{class:!0});var q=x(d);f=g(q,"DIV",{class:!0});var O=x(f);m=g(O,"SPAN",{"data-svelte-h":!0}),J(m)!=="svelte-9tuuyy"&&(m.textContent=S),w=D(O),C=g(O,"SPAN",{});var V=x(C);M=te(V,i[2]),E=te(V,"/"),p=te(V,i[3]),V.forEach(b),O.forEach(b),P=D(q),z=g(q,"DIV",{class:!0});var W=x(z);k=g(W,"DIV",{class:!0,style:!0}),x(k).forEach(b),W.forEach(b),q.forEach(b),ee.forEach(b),U=D(j),T=g(j,"DIV",{class:!0});var ue=x(T);N=g(ue,"BUTTON",{class:!0});var y=x(N);L=te(y,"Stats"),y.forEach(b),oe=D(ue),K=g(ue,"BUTTON",{class:!0});var _=x(K);ie=te(_,"Skills"),_.forEach(b),ue.forEach(b),H=D(j),G&&G.l(j),ve=D(j),ne&&ne.l(j),j.forEach(b),this.h()},h(){u(s,"class","text-2xl font-bold text-gray-100"),u(r,"class","text-gray-400"),u(f,"class","flex justify-between text-xs text-gray-400 mb-1"),u(k,"class","bg-purple-500 h-2 rounded-full transition-all"),Ye(k,"width",i[12]+"%"),u(z,"class","w-full bg-gray-700 rounded-full h-2"),u(d,"class","mt-2"),u(t,"class","mb-4"),u(N,"class",F="flex-1 py-2 text-center text-sm font-bold uppercase transition-colors "+(i[11]==="stats"?"text-blue-400 border-b-2 border-blue-400":"text-gray-500 hover:text-gray-300")),u(K,"class",$="flex-1 py-2 text-center text-sm font-bold uppercase transition-colors "+(i[11]==="skills"?"text-blue-400 border-b-2 border-blue-400":"text-gray-500 hover:text-gray-300")),u(T,"class","flex border-b border-gray-700 mb-4"),u(e,"class","character-sheet bg-gray-900 rounded-lg p-4 w-full max-w-md mx-auto max-h-[80vh] overflow-y-auto")},m(X,j){re(X,e,j),c(e,t),c(t,s),c(s,n),c(t,l),c(t,r),c(r,a),c(r,o),c(t,h),c(t,d),c(d,f),c(f,m),c(f,w),c(f,C),c(C,M),c(C,E),c(C,p),c(d,P),c(d,z),c(z,k),c(e,U),c(e,T),c(T,N),c(N,L),c(T,oe),c(T,K),c(K,ie),c(e,H),G&&G.m(e,null),c(e,ve),ne&&ne.m(e,null),A||(Q=[ae(N,"click",i[13]),ae(K,"click",i[14])],A=!0)},p(X,[j]){j&1&&de(n,X[0]),j&2&&de(o,X[1]),j&4&&de(M,X[2]),j&8&&de(p,X[3]),j&4096&&Ye(k,"width",X[12]+"%"),j&2048&&F!==(F="flex-1 py-2 text-center text-sm font-bold uppercase transition-colors "+(X[11]==="stats"?"text-blue-400 border-b-2 border-blue-400":"text-gray-500 hover:text-gray-300"))&&u(N,"class",F),j&2048&&$!==($="flex-1 py-2 text-center text-sm font-bold uppercase transition-colors "+(X[11]==="skills"?"text-blue-400 border-b-2 border-blue-400":"text-gray-500 hover:text-gray-300"))&&u(K,"class",$),X[11]==="stats"?G?G.p(X,j):(G=_t(X),G.c(),G.m(e,ve)):G&&(G.d(1),G=null),X[11]==="skills"?ne?ne.p(X,j):(ne=wt(X),ne.c(),ne.m(e,null)):ne&&(ne.d(1),ne=null)},i:ge,o:ge,d(X){X&&b(e),G&&G.d(),ne&&ne.d(),A=!1,je(Q)}}}function ds(i,e,t){let s,{characterName:n="Adventurer"}=e,{level:l=1}=e,{experience:r=0}=e,{nextLevelXP:a=100}=e,{strength:o=10}=e,{dexterity:h=10}=e,{constitution:d=10}=e,{intelligence:f=10}=e,{wisdom:m=10}=e,{charisma:S=10}=e,{skills:w={}}=e,C="stats";const M=()=>t(11,C="stats"),E=()=>t(11,C="skills");return i.$$set=p=>{"characterName"in p&&t(0,n=p.characterName),"level"in p&&t(1,l=p.level),"experience"in p&&t(2,r=p.experience),"nextLevelXP"in p&&t(3,a=p.nextLevelXP),"strength"in p&&t(4,o=p.strength),"dexterity"in p&&t(5,h=p.dexterity),"constitution"in p&&t(6,d=p.constitution),"intelligence"in p&&t(7,f=p.intelligence),"wisdom"in p&&t(8,m=p.wisdom),"charisma"in p&&t(9,S=p.charisma),"skills"in p&&t(10,w=p.skills)},i.$$.update=()=>{i.$$.dirty&12&&t(12,s=r/a*100)},[n,l,r,a,o,h,d,f,m,S,w,C,s,M,E]}class us extends Ee{constructor(e){super(),Te(this,e,ds,cs,Ce,{characterName:0,level:1,experience:2,nextLevelXP:3,strength:4,dexterity:5,constitution:6,intelligence:7,wisdom:8,charisma:9,skills:10})}}function kt(i){const e=i.toLowerCase();return e==="lobby"||e==="default"||e==="void"?"#333333":null}function hs(i,e,t=200){return Math.abs(i.z-e.elevation)<t?"near":"far"}const fe=i=>{const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}},Oe={Ocean:fe("#4682B4"),Rainforest:fe("#228B22"),DeciduousForest:fe("#3C783C"),Taiga:fe("#32503C"),Grassland:fe("#90EE90"),Desert:fe("#F4A460"),Tundra:fe("#E0FFFF"),Alpine:fe("#808080"),Lobby:fe("#505064"),Void:fe("#14141E"),Default:fe("#333333")},Fe=[{el:-4e3,color:fe("#0a1929")},{el:-2e3,color:fe("#0d3a5c")},{el:-200,color:fe("#1565c0")},{el:0,color:fe("#4fc3f7")},{el:200,color:fe("#66bb6a")},{el:500,color:fe("#aed581")},{el:1500,color:fe("#dce775")},{el:3e3,color:fe("#a1887f")},{el:5e3,color:fe("#9e9e9e")},{el:8e3,color:fe("#fafafa")}],Qe={player:"@",npc:"N",monster:"M",resource:"*",portal:"O",Ocean:"~",Rainforest:"T",DeciduousForest:"t",Taiga:"^",Grassland:".",Desert:":",Tundra:"_",Alpine:"A",lobby:"â–ª",void:"#",default:"?"},Xe={player:"ðŸ§",npc:"ðŸ‘¤",monster:"âš”ï¸",resource:"ðŸ’Ž",portal:"ðŸŒ€",Ocean:"ðŸŒŠ",Rainforest:"ðŸŒ³",DeciduousForest:"ðŸŒ²",Taiga:"ðŸŒ²",Grassland:"ðŸŒ¿",Desert:"ðŸœï¸",Tundra:"â„ï¸",Alpine:"ðŸ—»",lobby:"â—»",void:"â¬›",default:"Â·"};class qt{constructor(e){le(this,"canvas");le(this,"ctx");le(this,"tileSize",16);le(this,"quality","low");le(this,"style","standard");le(this,"running",!1);le(this,"dirty",!1);le(this,"frameId",null);le(this,"playerPos",{x:0,y:0,z:0});le(this,"visibleTiles",[]);le(this,"scale",1);le(this,"viewMode","local");le(this,"cameraPos",{x:0,y:0});le(this,"worldSize",2e3);le(this,"nearBuffer",null);le(this,"farBuffer",null);le(this,"bufferSize",0);le(this,"loop",()=>{this.running&&(this.dirty&&(this.render(),this.dirty=!1),this.frameId=requestAnimationFrame(this.loop))});this.canvas=e;const t=e.getContext("2d",{alpha:!1});if(!t)throw new Error("Could not get 2D context");this.ctx=t,this.canvas.setAttribute("role","img"),this.canvas.setAttribute("aria-label","Game Map")}setViewMode(e){this.viewMode=e,this.dirty=!0}setWorldSize(e){this.worldSize=e}pan(e,t){this.cameraPos.x+=e/this.scale,this.cameraPos.y+=t/this.scale,this.dirty=!0}zoom(e){e<0?this.scale*=1.1:this.scale/=1.1,this.scale=Math.max(.1,Math.min(this.scale,20)),this.dirty=!0}start(){this.running||(this.running=!0,this.loop())}stop(){this.running=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null)}setTileSize(e){this.tileSize!==e&&(this.tileSize=e,this.dirty=!0)}setQuality(e){this.quality!==e&&(this.quality=e,this.dirty=!0)}setStyle(e){this.style!==e&&(this.style=e,this.dirty=!0)}updateData(e,t,s=1,n=!1){this.playerPos=e,this.visibleTiles=t,(this.viewMode==="local"||n)&&(this.viewMode,this.cameraPos={...e}),this.dirty=!0}initBuffers(e){(!this.nearBuffer||!this.farBuffer||this.bufferSize!==e)&&(this.bufferSize=e,this.nearBuffer=document.createElement("canvas"),this.nearBuffer.width=e,this.nearBuffer.height=e,this.farBuffer=document.createElement("canvas"),this.farBuffer.width=e,this.farBuffer.height=e);const t=this.nearBuffer.getContext("2d"),s=this.farBuffer.getContext("2d");t&&t.clearRect(0,0,e,e),s&&s.clearRect(0,0,e,e)}render(){if(this.style==="geology"&&this.viewMode==="atlas"){this.renderHybridMap();return}const e=this.canvas.width,t=this.canvas.height,s=e/2,n=t/2;this.ctx.fillStyle="#1a1a2e",this.ctx.fillRect(0,0,e,t);const l=this.scale>0?this.scale:1,r=this.cameraPos;for(const a of this.visibleTiles){const o=s+(a.x-r.x)*this.tileSize*l,h=n-(a.y-r.y)*this.tileSize*l,d=this.tileSize;o<-d||o>e+d||h<-d||h>t+d||this.renderTile(a,o,h)}this.renderPlayer(s,n)}renderTile(e,t,s){if(this.style==="geology"){this.renderGeologyTile(e,t,s);return}this.quality==="low"?this.renderAsciiTile(e,t,s):this.quality==="medium"?this.renderIconTile(e,t,s):this.renderEmojiTile(e,t,s)}renderGeologyTile(e,t,s){let n=kt(e.biome);n||(n=this.getHypsometricColorString(e.elevation)),this.ctx.fillStyle=n;const l=this.tileSize+.6;this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,l,l),e.occluded&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize))}renderAsciiTile(e,t,s){var r,a;if(this.ctx.fillStyle=this.getBiomeColorString(e.biome,.3),this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.strokeRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize),e.occluded){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize);return}let n=Qe[e.biome]||Qe.default,l="#888888";(r=e.portal)!=null&&r.active&&(n=Qe.portal,l="#FF00FF"),(a=e.entities)!=null&&a[0]&&(n=Qe[e.entities[0].type]||"E",l=this.getEntityColor(e.entities[0].type)),this.ctx.fillStyle=l,this.ctx.font=`bold ${this.tileSize*.7}px monospace`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(n,t,s)}renderIconTile(e,t,s){var l,r;this.ctx.fillStyle=this.getBiomeColorString(e.biome,.6),this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize);const n=Math.max(0,Math.min(.2,e.elevation/5e3));if(this.ctx.fillStyle=`rgba(255, 255, 255, ${n})`,this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize),this.ctx.strokeStyle="rgba(255, 255, 255, 0.15)",this.ctx.strokeRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize),e.occluded){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(t-this.tileSize/2,s-this.tileSize/2,this.tileSize,this.tileSize);return}(l=e.portal)!=null&&l.active&&(this.ctx.fillStyle="#FF00FF",this.ctx.beginPath(),this.ctx.arc(t,s,this.tileSize/3,0,Math.PI*2),this.ctx.fill()),(r=e.entities)!=null&&r[0]&&(this.ctx.fillStyle=this.getEntityColor(e.entities[0].type),this.ctx.beginPath(),this.ctx.arc(t,s,this.tileSize/4,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.stroke())}renderEmojiTile(e,t,s){var a,o;const n=this.tileSize/2,l=e.elevation!==0?this.getHypsometricColorString(e.elevation):this.getBiomeColorString(e.biome);if(this.ctx.fillStyle=l,this.ctx.fillRect(t-n,s-n,this.tileSize+.5,this.tileSize+.5),e.occluded){this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(t-n,s-n,this.tileSize+.5,this.tileSize+.5);return}if(this.tileSize>=8&&(this.ctx.strokeStyle="rgba(255, 255, 255, 0.15)",this.ctx.strokeRect(t-n,s-n,this.tileSize,this.tileSize)),this.tileSize<3)return;const r=Xe[e.biome]||Xe.default;if(this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.font=`${this.tileSize*.56}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(r,t,s),this.ctx.restore(),(a=e.entities)!=null&&a[0]){const h=e.entities[0],d=h.glyph||Xe[h.type]||"ðŸ‘¤";this.ctx.font=`${this.tileSize*.35}px Arial`,this.ctx.fillText(d,t,s)}else(o=e.portal)!=null&&o.active&&(this.ctx.font=`${this.tileSize*.6}px Arial`,this.ctx.fillText(Xe.portal,t,s))}renderHybridMap(){const e=this.worldSize||2e3;this.initBuffers(e);const t=this.nearBuffer.getContext("2d"),s=this.farBuffer.getContext("2d");if(!t||!s)return;const n=this.playerPos.z||0;for(const C of this.visibleTiles){let M=kt(C.biome);M||(M=this.getHypsometricColorString(C.elevation));const p=hs({x:this.playerPos.x,y:this.playerPos.y,z:n},{x:C.x,y:C.y,elevation:C.elevation,biome:C.biome})==="near"?t:s;p.fillStyle=M,p.fillRect(C.x,C.y,1,1),C.occluded&&(p.fillStyle="rgba(0, 0, 0, 0.6)",p.fillRect(C.x,C.y,1,1))}const l=this.canvas.width,r=this.canvas.height,a=l/2,o=r/2;this.ctx.fillStyle="#1a1a2e",this.ctx.fillRect(0,0,l,r);const h=this.scale,d=e*h,f=e*h;this.ctx.save(),this.ctx.translate(a,o),this.ctx.scale(1,-1);const m=-this.cameraPos.x*h,S=-this.cameraPos.y*h,w=h<1;this.ctx.imageSmoothingEnabled=!!w,this.ctx.drawImage(this.farBuffer,m,S,d,f),this.ctx.imageSmoothingEnabled=!0,this.ctx.drawImage(this.nearBuffer,m,S,d,f),this.ctx.restore(),this.renderPlayer(a,o)}renderPlayer(e,t){this.ctx.fillStyle=this.quality==="high"?"rgba(255, 215, 0, 0.3)":"#FFD700",this.quality==="high"&&(this.ctx.fillRect(e-this.tileSize/2,t-this.tileSize/2,this.tileSize,this.tileSize),this.ctx.fillStyle="#FFD700");const s=this.quality==="high"?"ðŸ§":"@";this.ctx.font=this.quality==="high"?`${this.tileSize*.7}px Arial`:`bold ${this.tileSize*.8}px monospace`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(s,e,t),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(e-this.tileSize/2+1,t-this.tileSize/2+1,this.tileSize-2,this.tileSize-2)}getBiomeColorString(e,t=1){let s=Oe[e];if(!s){const l=Object.keys(Oe).find(r=>r.toLowerCase()===e.toLowerCase());l&&(s=Oe[l]),s||(s=Oe.Default)}const n=s||{r:51,g:51,b:51};return`rgba(${n.r}, ${n.g}, ${n.b}, ${t})`}getHypsometricColorString(e){for(let l=0;l<Fe.length-1;l++){const r=Fe[l],a=Fe[l+1];if(r&&a&&e>=r.el&&e<=a.el){const o=(e-r.el)/(a.el-r.el);return this.lerpRgbToString(r.color,a.color,o)}}const t=Fe[0],s=Fe[Fe.length-1];if(t&&e<t.el)return this.rgbToString(t.color);if(s)return this.rgbToString(s.color);const n=Oe.Default||{r:51,g:51,b:51};return this.rgbToString(n)}lerpRgbToString(e,t,s){const n=Math.round(e.r+(t.r-e.r)*s),l=Math.round(e.g+(t.g-e.g)*s),r=Math.round(e.b+(t.b-e.b)*s);return`rgb(${n}, ${l}, ${r})`}rgbToString(e){return`rgb(${e.r}, ${e.g}, ${e.b})`}getEntityColor(e){return{npc:"#FFFF00",player:"#00FFFF",resource:"#FFA500",monster:"#FF0000",item:"#FFA500"}[e]||"#FFFFFF"}}function St(i,e,t){const s=i.slice();return s[15]=e[t],s}function Ct(i){let e,t,s,n,l="World Map & Simulation",r,a,o,h,d,f=i[5].year+"",m,S,w,C='<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',M,E,p,P,z,k,U='<div class="bg-gray-800/80 p-2 rounded text-xs text-gray-300">WASD to Pan â€¢ Scroll to Zoom</div>',T,N,L,F,oe='<h3 class="font-bold text-gray-300 mb-2">Ecosystem Stats</h3> <div class="grid grid-cols-2 gap-2 text-sm"><div class="bg-gray-800 p-2 rounded"><div class="text-gray-500 text-xs">Population</div> <div class="text-green-400 font-mono">--</div></div> <div class="bg-gray-800 p-2 rounded"><div class="text-gray-500 text-xs">Species</div> <div class="text-yellow-400 font-mono">--</div></div> <div class="bg-gray-800 p-2 rounded"><div class="text-gray-500 text-xs">Temperature</div> <div class="text-red-400 font-mono">--Â°C</div></div> <div class="bg-gray-800 p-2 rounded"><div class="text-gray-500 text-xs">CO2</div> <div class="text-blue-400 font-mono">-- ppm</div></div></div>',K,ie,$,H="Event Log",ve,A,Q,G,ne,X,j=ye(i[5].events),ee=[];for(let Y=0;Y<j.length;Y+=1)ee[Y]=Tt(St(i,j,Y));let Z=null;return j.length||(Z=Et()),{c(){e=v("div"),t=v("div"),s=v("div"),n=v("h2"),n.textContent=l,r=I(),a=v("div"),o=v("div"),h=se("Year: "),d=v("span"),m=se(f),S=I(),w=v("button"),w.innerHTML=C,M=I(),E=v("div"),p=v("div"),P=v("canvas"),z=I(),k=v("div"),k.innerHTML=U,N=I(),L=v("div"),F=v("div"),F.innerHTML=oe,K=I(),ie=v("div"),$=v("h3"),$.textContent=H,ve=I(),A=v("div");for(let Y=0;Y<ee.length;Y+=1)ee[Y].c();Z&&Z.c(),this.h()},l(Y){e=g(Y,"DIV",{class:!0});var q=x(e);t=g(q,"DIV",{class:!0});var O=x(t);s=g(O,"DIV",{class:!0});var V=x(s);n=g(V,"H2",{class:!0,"data-svelte-h":!0}),J(n)!=="svelte-1kpv5fi"&&(n.textContent=l),r=D(V),a=g(V,"DIV",{class:!0});var W=x(a);o=g(W,"DIV",{class:!0});var ue=x(o);h=te(ue,"Year: "),d=g(ue,"SPAN",{class:!0});var y=x(d);m=te(y,f),y.forEach(b),ue.forEach(b),S=D(W),w=g(W,"BUTTON",{class:!0,"data-svelte-h":!0}),J(w)!=="svelte-lulo1"&&(w.innerHTML=C),W.forEach(b),V.forEach(b),M=D(O),E=g(O,"DIV",{class:!0});var _=x(E);p=g(_,"DIV",{class:!0});var B=x(p);P=g(B,"CANVAS",{width:!0,height:!0,class:!0}),x(P).forEach(b),z=D(B),k=g(B,"DIV",{class:!0,"data-svelte-h":!0}),J(k)!=="svelte-1ha78jc"&&(k.innerHTML=U),B.forEach(b),N=D(_),L=g(_,"DIV",{class:!0});var R=x(L);F=g(R,"DIV",{class:!0,"data-svelte-h":!0}),J(F)!=="svelte-63h2bi"&&(F.innerHTML=oe),K=D(R),ie=g(R,"DIV",{class:!0});var ce=x(ie);$=g(ce,"H3",{class:!0,"data-svelte-h":!0}),J($)!=="svelte-10tq5ud"&&($.textContent=H),ve=D(ce),A=g(ce,"DIV",{class:!0});var me=x(A);for(let _e=0;_e<ee.length;_e+=1)ee[_e].l(me);Z&&Z.l(me),me.forEach(b),ce.forEach(b),R.forEach(b),_.forEach(b),O.forEach(b),q.forEach(b),this.h()},h(){u(n,"class","text-xl font-bold text-blue-400"),u(d,"class","text-white font-mono"),u(o,"class","text-sm text-gray-400"),u(w,"class","text-gray-400 hover:text-white transition-colors"),u(a,"class","flex gap-4"),u(s,"class","flex justify-between items-center p-4 border-b border-gray-800 bg-gray-800/50"),u(P,"width",i[3]),u(P,"height",i[4]),u(P,"class","block w-full h-full"),u(k,"class","absolute bottom-4 right-4 flex gap-2"),u(p,"class","flex-1 bg-black relative"),ot(()=>i[9].call(p)),u(F,"class","p-4 border-b border-gray-800"),u($,"class","font-bold text-gray-300 p-4 pb-2"),u(A,"class","flex-1 overflow-y-auto p-4 pt-0 space-y-2 font-mono text-xs"),u(ie,"class","flex-1 flex flex-col overflow-hidden"),u(L,"class","w-80 bg-gray-850 border-l border-gray-800 flex flex-col"),u(E,"class","flex-1 flex overflow-hidden"),u(t,"class","bg-gray-900 border border-gray-700 rounded-lg shadow-2xl w-[90vw] h-[90vh] flex flex-col overflow-hidden"),u(e,"class","fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm")},m(Y,q){re(Y,e,q),c(e,t),c(t,s),c(s,n),c(s,r),c(s,a),c(a,o),c(o,h),c(o,d),c(d,m),c(a,S),c(a,w),c(t,M),c(t,E),c(E,p),c(p,P),i[8](P),c(p,z),c(p,k),T=Qt(p,i[9].bind(p)),c(E,N),c(E,L),c(L,F),c(L,K),c(L,ie),c(ie,$),c(ie,ve),c(ie,A);for(let O=0;O<ee.length;O+=1)ee[O]&&ee[O].m(A,null);Z&&Z.m(A,null),G=!0,ne||(X=ae(w,"click",function(){Xt(i[1])&&i[1].apply(this,arguments)}),ne=!0)},p(Y,q){if(i=Y,(!G||q&32)&&f!==(f=i[5].year+"")&&de(m,f),(!G||q&8)&&u(P,"width",i[3]),(!G||q&16)&&u(P,"height",i[4]),q&32){j=ye(i[5].events);let O;for(O=0;O<j.length;O+=1){const V=St(i,j,O);ee[O]?ee[O].p(V,q):(ee[O]=Tt(V),ee[O].c(),ee[O].m(A,null))}for(;O<ee.length;O+=1)ee[O].d(1);ee.length=j.length,!j.length&&Z?Z.p(i,q):j.length?Z&&(Z.d(1),Z=null):(Z=Et(),Z.c(),Z.m(A,null))}},i(Y){G||(Y&&ot(()=>{G&&(Q||(Q=ut(e,ft,{},!0)),Q.run(1))}),G=!0)},o(Y){Y&&(Q||(Q=ut(e,ft,{},!1)),Q.run(0)),G=!1},d(Y){Y&&b(e),i[8](null),T(),Ne(ee,Y),Z&&Z.d(),Y&&Q&&Q.end(),ne=!1,X()}}}function Et(i){let e,t=`No recent events
                                `;return{c(){e=v("div"),e.textContent=t,this.h()},l(s){e=g(s,"DIV",{class:!0,"data-svelte-h":!0}),J(e)!=="svelte-1wo3kiy"&&(e.textContent=t),this.h()},h(){u(e,"class","text-gray-600 italic text-center mt-10")},m(s,n){re(s,e,n)},p:ge,d(s){s&&b(e)}}}function Tt(i){let e,t=i[15]+"",s,n;return{c(){e=v("div"),s=se(t),n=I(),this.h()},l(l){e=g(l,"DIV",{class:!0});var r=x(e);s=te(r,t),n=D(r),r.forEach(b),this.h()},h(){u(e,"class","text-gray-400 border-l-2 border-gray-700 pl-2 py-1")},m(l,r){re(l,e,r),c(e,s),c(e,n)},p(l,r){r&32&&t!==(t=l[15]+"")&&de(s,t)},d(l){l&&b(e)}}}function fs(i){let e,t=i[0]&&Ct(i);return{c(){t&&t.c(),e=at()},l(s){t&&t.l(s),e=at()},m(s,n){t&&t.m(s,n),re(s,e,n)},p(s,[n]){s[0]?t?(t.p(s,n),n&1&&he(t,1)):(t=Ct(s),t.c(),he(t,1),t.m(e.parentNode,e)):t&&(Ae(),pe(t,1,1,()=>{t=null}),Re())},i(s){he(t)},o(s){pe(t)},d(s){s&&b(e),t&&t.d(s)}}}function gs(i,e,t){let s;Rt(i,Je,p=>t(7,s=p));let{isOpen:n=!1}=e,{onClose:l}=e,r,a=null,o=0,h=0,d={year:0,population:0,species:0,events:[]};function f(){!r||a||!r.getContext("2d",{alpha:!1})||(t(6,a=new qt(r)),a.setTileSize(4),a.setViewMode("atlas"),s.data&&a.setWorldSize(s.data.grid_size||2e3),a.start(),s.data&&m())}function m(){if(!a||!s.data)return;const p={x:Math.round(s.data.player_x),y:Math.round(s.data.player_y),z:Math.round(s.data.player_z||0)};s.data.grid_size&&a.setWorldSize(s.data.grid_size);const P=s.data.tiles.map(z=>{const k={x:z.x,y:z.y,biome:z.biome||"Default",elevation:z.elevation||0,entities:z.entities||[]};return z.is_player&&(k.is_player=!0),z.portal&&(k.portal=z.portal),z.occluded&&(k.occluded=!0),k});a.updateData(p,P,1)}function S(p){if(p.type==="sim_event"){t(5,d.year=p.data.year||d.year,d);const P=`Year ${p.data.year}: ${p.text}`;t(5,d.events=[P,...d.events].slice(0,50),d)}else p.type==="game_message"&&p.data.type}tt(()=>{const p=ke.onMessage(S);return window.addEventListener("keydown",w),window.addEventListener("wheel",C),()=>{p(),window.removeEventListener("keydown",w),window.removeEventListener("wheel",C)}});function w(p){if(!n||!a)return;const P=20;switch(p.key.toLowerCase()){case"w":a.pan(0,P);break;case"s":a.pan(0,-P);break;case"a":a.pan(-P,0);break;case"d":a.pan(P,0);break}}function C(p){!n||!a||a.zoom(p.deltaY)}st(()=>{a&&a.stop()});function M(p){Nt[p?"unshift":"push"](()=>{r=p,t(2,r)})}function E(){o=this.clientWidth,h=this.clientHeight,t(3,o),t(4,h)}return i.$$set=p=>{"isOpen"in p&&t(0,n=p.isOpen),"onClose"in p&&t(1,l=p.onClose)},i.$$.update=()=>{i.$$.dirty&5&&n&&r&&f(),i.$$.dirty&65&&!n&&a&&(a.stop(),t(6,a=null)),i.$$.dirty&193&&a&&s.data&&n&&m()},[n,l,r,o,h,d,a,s,M,E]}class vs extends Ee{constructor(e){super(),Te(this,e,gs,fs,Ce,{isOpen:0,onClose:1})}}const ms={light:10,medium:15,heavy:20,selection:5,error:[10,50,10],success:[10,50,10,50,10]},rt=$e(!0);if(typeof localStorage<"u"){const i=localStorage.getItem("hapticEnabled");i!==null&&rt.set(i==="true")}rt.subscribe(i=>{typeof localStorage<"u"&&localStorage.setItem("hapticEnabled",String(i))});let Ht=!0;rt.subscribe(i=>{Ht=i});function Le(i){if(!Ht||!("vibrate"in navigator))return;const e=ms[i];Array.isArray(e),navigator.vibrate(e)}const it={light:()=>Le("light"),medium:()=>Le("medium"),heavy:()=>Le("heavy"),selection:()=>Le("selection"),error:()=>Le("error"),success:()=>Le("success")};function ps(i){let e,t,s,n,l,r,a,o;return{c(){e=v("div"),t=v("input"),s=I(),n=v("button"),l=se("Send"),this.h()},l(h){e=g(h,"DIV",{class:!0});var d=x(e);t=g(d,"INPUT",{id:!0,type:!0,placeholder:!0,class:!0,style:!0,autocomplete:!0,autocorrect:!0,autocapitalize:!0,spellcheck:!0}),s=D(d),n=g(d,"BUTTON",{class:!0,"aria-label":!0});var f=x(n);l=te(f,"Send"),f.forEach(b),d.forEach(b),this.h()},h(){u(t,"id","game-input"),u(t,"type","text"),u(t,"placeholder","Enter command..."),u(t,"class","flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-100 text-base placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 svelte-1o25vz6"),Ye(t,"font-size","16px"),u(t,"autocomplete","off"),u(t,"autocorrect","off"),u(t,"autocapitalize","off"),u(t,"spellcheck","false"),n.disabled=r=!i[0].trim(),u(n,"class","min-w-[44px] min-h-[44px] px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center"),u(n,"aria-label","Send command"),u(e,"class","flex gap-2 w-full")},m(h,d){re(h,e,d),c(e,t),Ge(t,i[0]),c(e,s),c(e,n),c(n,l),a||(o=[ae(t,"input",i[3]),ae(t,"keydown",i[2]),ae(n,"click",i[1])],a=!0)},p(h,[d]){d&1&&t.value!==h[0]&&Ge(t,h[0]),d&1&&r!==(r=!h[0].trim())&&(n.disabled=r)},i:ge,o:ge,d(h){h&&b(e),a=!1,je(o)}}}function bs(i,e,t){const s=Ke();let n="",l=[],r=-1;function a(){n.trim()&&(it.light(),s("submit",n.trim()),l.unshift(n),l.length>50&&l.pop(),t(0,n=""),r=-1)}function o(d){d.key==="Enter"&&!d.shiftKey?(d.preventDefault(),a()):d.key==="ArrowUp"?(d.preventDefault(),r<l.length-1&&(r++,t(0,n=l[r]))):d.key==="ArrowDown"?(d.preventDefault(),r>0?(r--,t(0,n=l[r])):r===0&&(r=-1,t(0,n=""))):d.key==="Escape"&&(t(0,n=""),r=-1)}function h(){n=this.value,t(0,n)}return[n,a,o,h]}class ys extends Ee{constructor(e){super(),Te(this,e,bs,ps,Ce,{})}}function _s(i){let e,t,s='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(-45deg)"><path d="m18 15-6-6-6 6"></path></svg>',n,l,r='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"></path></svg>',a,o,h='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(45deg)"><path d="m18 15-6-6-6 6"></path></svg>',d,f,m='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(-90deg)"><path d="m18 15-6-6-6 6"></path></svg>',S,w,C="LOOK",M,E,p='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(90deg)"><path d="m18 15-6-6-6 6"></path></svg>',P,z,k='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(-135deg)"><path d="m18 15-6-6-6 6"></path></svg>',U,T,N='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(180deg)"><path d="m18 15-6-6-6 6"></path></svg>',L,F,oe='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(135deg)"><path d="m18 15-6-6-6 6"></path></svg>',K,ie;return{c(){e=v("div"),t=v("button"),t.innerHTML=s,n=I(),l=v("button"),l.innerHTML=r,a=I(),o=v("button"),o.innerHTML=h,d=I(),f=v("button"),f.innerHTML=m,S=I(),w=v("button"),w.textContent=C,M=I(),E=v("button"),E.innerHTML=p,P=I(),z=v("button"),z.innerHTML=k,U=I(),T=v("button"),T.innerHTML=N,L=I(),F=v("button"),F.innerHTML=oe,this.h()},l($){e=g($,"DIV",{class:!0,role:!0,"aria-label":!0});var H=x(e);t=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(t)!=="svelte-iknoph"&&(t.innerHTML=s),n=D(H),l=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(l)!=="svelte-1vym5xw"&&(l.innerHTML=r),a=D(H),o=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(o)!=="svelte-129hiuk"&&(o.innerHTML=h),d=D(H),f=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(f)!=="svelte-l1fib4"&&(f.innerHTML=m),S=D(H),w=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(w)!=="svelte-wpwm8s"&&(w.textContent=C),M=D(H),E=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(E)!=="svelte-1mhbnd1"&&(E.innerHTML=p),P=D(H),z=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(z)!=="svelte-15qq2ny"&&(z.innerHTML=k),U=D(H),T=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(T)!=="svelte-q0ox9v"&&(T.innerHTML=N),L=D(H),F=g(H,"BUTTON",{class:!0,"aria-label":!0,"data-svelte-h":!0}),J(F)!=="svelte-1nlttuj"&&(F.innerHTML=oe),H.forEach(b),this.h()},h(){u(t,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 rounded-tl-lg transition-colors"),u(t,"aria-label","Northwest"),u(l,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 transition-colors"),u(l,"aria-label","North"),u(o,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 rounded-tr-lg transition-colors"),u(o,"aria-label","Northeast"),u(f,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 transition-colors"),u(f,"aria-label","West"),u(w,"class","w-12 h-12 flex items-center justify-center bg-gray-700 hover:bg-gray-600 active:bg-blue-600 font-bold text-xs text-gray-300 transition-colors"),u(w,"aria-label","Look"),u(E,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 transition-colors"),u(E,"aria-label","East"),u(z,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 rounded-bl-lg transition-colors"),u(z,"aria-label","Southwest"),u(T,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 transition-colors"),u(T,"aria-label","South"),u(F,"class","w-12 h-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 active:bg-blue-600 rounded-br-lg transition-colors"),u(F,"aria-label","Southeast"),u(e,"class","grid grid-cols-3 gap-1 w-fit p-2 bg-gray-800 rounded-xl border border-gray-700 shadow-lg"),u(e,"role","group"),u(e,"aria-label","Movement Controls")},m($,H){re($,e,H),c(e,t),c(e,n),c(e,l),c(e,a),c(e,o),c(e,d),c(e,f),c(e,S),c(e,w),c(e,M),c(e,E),c(e,P),c(e,z),c(e,U),c(e,T),c(e,L),c(e,F),K||(ie=[ae(t,"click",i[1]),ae(l,"click",i[2]),ae(o,"click",i[3]),ae(f,"click",i[4]),ae(w,"click",i[5]),ae(E,"click",i[6]),ae(z,"click",i[7]),ae(T,"click",i[8]),ae(F,"click",i[9])],K=!0)},p:ge,i:ge,o:ge,d($){$&&b(e),K=!1,je(ie)}}}function ws(i){const e=Ke();function t(m){it.selection(),e("command",m)}return[t,()=>t("nw"),()=>t("north"),()=>t("ne"),()=>t("west"),()=>t("look"),()=>t("east"),()=>t("sw"),()=>t("south"),()=>t("se")]}class xs extends Ee{constructor(e){super(),Te(this,e,ws,_s,Ce,{})}}function ks(i){var d;let e,t,s,n,l="N",r,a,o=Dt((d=i[0].data)==null?void 0:d.render_quality)+"",h;return{c(){e=v("div"),t=v("canvas"),s=I(),n=v("div"),n.textContent=l,r=I(),a=v("div"),h=se(o),this.h()},l(f){e=g(f,"DIV",{class:!0,"data-testid":!0});var m=x(e);t=g(m,"CANVAS",{width:!0,height:!0,class:!0}),x(t).forEach(b),s=D(m),n=g(m,"DIV",{class:!0,"data-svelte-h":!0}),J(n)!=="svelte-27zddx"&&(n.textContent=l),r=D(m),a=g(m,"DIV",{class:!0,title:!0});var S=x(a);h=te(S,o),S.forEach(b),m.forEach(b),this.h()},h(){u(t,"width",et),u(t,"height",et),u(t,"class","map-canvas svelte-ctrdyw"),u(n,"class","compass svelte-ctrdyw"),u(a,"class","quality-indicator svelte-ctrdyw"),u(a,"title","Perception Quality"),u(e,"class","mini-map-container svelte-ctrdyw"),u(e,"data-testid","mini-map")},m(f,m){re(f,e,m),c(e,t),i[5](t),c(e,s),c(e,n),c(e,r),c(e,a),c(a,h)},p(f,[m]){var S;m&1&&o!==(o=Dt((S=f[0].data)==null?void 0:S.render_quality)+"")&&de(h,o)},i:ge,o:ge,d(f){f&&b(e),i[5](null)}}}const et=152;function Dt(i){switch(i){case"high":return"â—†â—†â—†";case"medium":return"â—†â—†â—‹";default:return"â—†â—‹â—‹"}}function Ss(i,e,t){let s,n,l;Rt(i,Je,d=>t(0,l=d));let r,a=null;tt(()=>{console.log("[MiniMap] v2.2 Optimized Loop"),r&&(t(2,a=new qt(r)),a.setTileSize(n),a.start(),l.data&&(a.setQuality(l.data.render_quality||"low"),a.setStyle("geology"),o()))}),st(()=>{a&&a.stop()});function o(){if(!a||!l.data)return;const d={x:Math.round(l.data.player_x),y:Math.round(l.data.player_y),z:Math.round(l.data.player_z||0)},f=l.data.tiles.map(m=>{const S={x:m.x,y:m.y,biome:m.biome||"Default",elevation:m.elevation||0,entities:m.entities||[],is_player:m.is_player||!1,occluded:m.occluded||!1};return m.portal&&(S.portal=m.portal),S});a.updateData(d,f,l.data.scale||1)}function h(d){Nt[d?"unshift":"push"](()=>{r=d,t(1,r)})}return i.$$.update=()=>{var d;i.$$.dirty&1&&t(4,s=((d=l.data)==null?void 0:d.grid_size)||9),i.$$.dirty&16&&t(3,n=et/s),i.$$.dirty&13&&a&&l.data&&(a.setQuality(l.data.render_quality||"low"),a.setStyle("geology"),a.setTileSize(n),o())},[l,r,a,n,s,h]}class Cs extends Ee{constructor(e){super(),Te(this,e,Ss,ks,Ce,{})}}function It(i,e,t){const s=i.slice();return s[5]=e[t],s}function zt(i){let e,t=i[5].label+"",s,n,l,r,a;function o(){return i[3](i[5])}return{c(){e=v("button"),s=se(t),n=I(),this.h()},l(h){e=g(h,"BUTTON",{class:!0,"aria-label":!0});var d=x(e);s=te(d,t),n=D(d),d.forEach(b),this.h()},h(){u(e,"class","min-w-[44px] min-h-[44px] px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 rounded-lg transition-colors text-sm font-medium"),u(e,"aria-label",l=i[5].label)},m(h,d){re(h,e,d),c(e,s),c(e,n),r||(a=ae(e,"click",o),r=!0)},p(h,d){i=h,d&1&&t!==(t=i[5].label+"")&&de(s,t),d&1&&l!==(l=i[5].label)&&u(e,"aria-label",l)},d(h){h&&b(e),r=!1,a()}}}function Es(i){let e,t,s,n,l,r,a,o,h;s=new Cs({});let d=ye(i[0]),f=[];for(let m=0;m<d.length;m+=1)f[m]=zt(It(i,d,m));return o=new xs({}),o.$on("command",i[2]),{c(){e=v("div"),t=v("div"),Ve(s.$$.fragment),n=I(),l=v("div");for(let m=0;m<f.length;m+=1)f[m].c();r=I(),a=v("div"),Ve(o.$$.fragment),this.h()},l(m){e=g(m,"DIV",{class:!0});var S=x(e);t=g(S,"DIV",{class:!0});var w=x(t);Me(s.$$.fragment,w),w.forEach(b),n=D(S),l=g(S,"DIV",{class:!0});var C=x(l);for(let E=0;E<f.length;E+=1)f[E].l(C);C.forEach(b),r=D(S),a=g(S,"DIV",{class:!0});var M=x(a);Me(o.$$.fragment,M),M.forEach(b),S.forEach(b),this.h()},h(){u(t,"class","flex-shrink-0"),u(l,"class","flex flex-wrap gap-2 flex-1 justify-center"),u(a,"class","flex-shrink-0"),u(e,"class","flex flex-row gap-4 w-full items-end justify-between")},m(m,S){re(m,e,S),c(e,t),ze(s,t,null),c(e,n),c(e,l);for(let w=0;w<f.length;w+=1)f[w]&&f[w].m(l,null);c(e,r),c(e,a),ze(o,a,null),h=!0},p(m,[S]){if(S&3){d=ye(m[0]);let w;for(w=0;w<d.length;w+=1){const C=It(m,d,w);f[w]?f[w].p(C,S):(f[w]=zt(C),f[w].c(),f[w].m(l,null))}for(;w<f.length;w+=1)f[w].d(1);f.length=d.length}},i(m){h||(he(s.$$.fragment,m),he(o.$$.fragment,m),h=!0)},o(m){pe(s.$$.fragment,m),pe(o.$$.fragment,m),h=!1},d(m){m&&b(e),Ie(s),Ne(f,m),Ie(o)}}}function Ts(i,e,t){const s=Ke();let{commands:n=[{label:"Inventory",command:"inventory"},{label:"Help",command:"help"}]}=e;function l(o){it.selection(),s("submit",o)}function r(o){l(o.detail)}const a=o=>l(o.command);return i.$$set=o=>{"commands"in o&&t(0,n=o.commands)},[n,l,r,a]}class Ds extends Ee{constructor(e){super(),Te(this,e,Ts,Es,Ce,{commands:0})}}function Mt(i,e,t){const s=i.slice();return s[46]=e[t],s}function Vt(i,e,t){const s=i.slice();return s[46]=e[t],s}function jt(i){let e,t="Character",s,n,l="World Map",r,a;return{c(){e=v("button"),e.textContent=t,s=I(),n=v("button"),n.textContent=l,this.h()},l(o){e=g(o,"BUTTON",{class:!0,"data-svelte-h":!0}),J(e)!=="svelte-lsufuc"&&(e.textContent=t),s=D(o),n=g(o,"BUTTON",{class:!0,"data-svelte-h":!0}),J(n)!=="svelte-uaahhc"&&(n.textContent=l),this.h()},h(){u(e,"class","bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm transition-colors"),u(n,"class","bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded text-sm transition-colors")},m(o,h){re(o,e,h),re(o,s,h),re(o,n,h),r||(a=[ae(e,"click",i[15]),ae(n,"click",i[18])],r=!0)},p:ge,d(o){o&&(b(e),b(s),b(n)),r=!1,je(a)}}}function Is(i){let e,t=[],s=new Map,n=ye(i[5]);const l=r=>r[46].id;for(let r=0;r<n.length;r+=1){let a=Mt(i,n,r),o=l(a);s.set(o,t[r]=Pt(o,a))}return{c(){e=v("div");for(let r=0;r<t.length;r+=1)t[r].c();this.h()},l(r){e=g(r,"DIV",{class:!0,id:!0,"data-testid":!0});var a=x(e);for(let o=0;o<t.length;o+=1)t[o].l(a);a.forEach(b),this.h()},h(){u(e,"class","flex-1 overflow-y-auto p-4 space-y-2 scroll-smooth"),u(e,"id","game-output"),u(e,"data-testid","game-output")},m(r,a){re(r,e,a);for(let o=0;o<t.length;o+=1)t[o]&&t[o].m(e,null)},p(r,a){a[0]&32&&(n=ye(r[5]),t=Zt(t,a,l,1,r,n,s,e,Kt,Pt,null,Mt))},d(r){r&&b(e);for(let a=0;a<t.length;a+=1)t[a].d()}}}function zs(i){let e,t,s=ye(i[2]),n=[];for(let r=0;r<s.length;r+=1)n[r]=Ft(Vt(i,s,r));let l=i[1]&&Lt(i);return{c(){e=v("div");for(let r=0;r<n.length;r+=1)n[r].c();t=I(),l&&l.c(),this.h()},l(r){e=g(r,"DIV",{class:!0,id:!0,"data-testid":!0});var a=x(e);for(let o=0;o<n.length;o+=1)n[o].l(a);t=D(a),l&&l.l(a),a.forEach(b),this.h()},h(){u(e,"class","flex-1 flex flex-col p-4 overflow-y-auto"),u(e,"id","game-output"),u(e,"data-testid","game-output")},m(r,a){re(r,e,a);for(let o=0;o<n.length;o+=1)n[o]&&n[o].m(e,null);c(e,t),l&&l.m(e,null)},p(r,a){if(a[0]&4){s=ye(r[2]);let o;for(o=0;o<s.length;o+=1){const h=Vt(r,s,o);n[o]?n[o].p(h,a):(n[o]=Ft(h),n[o].c(),n[o].m(e,t))}for(;o<n.length;o+=1)n[o].d(1);n.length=s.length}r[1]?l?l.p(r,a):(l=Lt(r),l.c(),l.m(e,null)):l&&(l.d(1),l=null)},d(r){r&&b(e),Ne(n,r),l&&l.d()}}}function Ms(i){let e,t='<div class="text-xl text-gray-400 animate-pulse">Loading...</div>';return{c(){e=v("div"),e.innerHTML=t,this.h()},l(s){e=g(s,"DIV",{class:!0,"data-svelte-h":!0}),J(e)!=="svelte-1nxqtd8"&&(e.innerHTML=t),this.h()},h(){u(e,"class","flex-1 flex items-center justify-center")},m(s,n){re(s,e,n)},p:ge,d(s){s&&b(e)}}}function Pt(i,e){let t,s,n=e[46].text.replace(/\n/g,"<br>")+"",l,r;return{key:i,first:null,c(){t=v("div"),s=new Jt(!1),l=I(),this.h()},l(a){t=g(a,"DIV",{class:!0});var o=x(t);s=Gt(o,!1),l=D(o),o.forEach(b),this.h()},h(){s.a=l,u(t,"class",r=Se(`message leading-relaxed ${e[46].type==="error"?"text-red-400":e[46].type==="system"?"text-yellow-400":e[46].type==="player"?"text-blue-300":e[46].type==="emote"?"text-orange-300 italic":"text-gray-300"}`)+" svelte-lcmnji"),this.first=t},m(a,o){re(a,t,o),s.m(n,t),c(t,l)},p(a,o){e=a,o[0]&32&&n!==(n=e[46].text.replace(/\n/g,"<br>")+"")&&s.p(n),o[0]&32&&r!==(r=Se(`message leading-relaxed ${e[46].type==="error"?"text-red-400":e[46].type==="system"?"text-yellow-400":e[46].type==="player"?"text-blue-300":e[46].type==="emote"?"text-orange-300 italic":"text-gray-300"}`)+" svelte-lcmnji")&&u(t,"class",r)},d(a){a&&b(t)}}}function Ft(i){let e,t,s=i[46].text+"",n,l,r;return{c(){e=v("div"),t=v("div"),n=se(s),this.h()},l(a){e=g(a,"DIV",{class:!0});var o=x(e);t=g(o,"DIV",{class:!0});var h=x(t);n=te(h,s),h.forEach(b),o.forEach(b),this.h()},h(){u(t,"class",l=Se(`inline-block p-3 rounded-lg max-w-[80%] ${i[46].role==="user"?"bg-blue-900/50 text-blue-100":"bg-gray-800/50 text-gray-100"}`)+" svelte-lcmnji"),u(e,"class",r=Se(`mb-4 ${i[46].role==="user"?"text-right":"text-left"}`)+" svelte-lcmnji")},m(a,o){re(a,e,o),c(e,t),c(t,n)},p(a,o){o[0]&4&&s!==(s=a[46].text+"")&&de(n,s),o[0]&4&&l!==(l=Se(`inline-block p-3 rounded-lg max-w-[80%] ${a[46].role==="user"?"bg-blue-900/50 text-blue-100":"bg-gray-800/50 text-gray-100"}`)+" svelte-lcmnji")&&u(t,"class",l),o[0]&4&&r!==(r=Se(`mb-4 ${a[46].role==="user"?"text-right":"text-left"}`)+" svelte-lcmnji")&&u(e,"class",r)},d(a){a&&b(e)}}}function Lt(i){let e,t,s;return{c(){e=v("div"),t=v("div"),s=se(i[1]),this.h()},l(n){e=g(n,"DIV",{class:!0});var l=x(e);t=g(l,"DIV",{class:!0});var r=x(t);s=te(r,i[1]),r.forEach(b),l.forEach(b),this.h()},h(){u(t,"class","inline-block p-3 rounded-lg max-w-[80%] bg-gray-800/50 text-gray-100 border-l-4 border-blue-500"),u(e,"class","mb-4 text-left")},m(n,l){re(n,e,l),c(e,t),c(t,s)},p(n,l){l[0]&2&&de(s,n[1])},d(n){n&&b(e)}}}function Bt(i){let e,t;return e=new Ds({}),e.$on("submit",i[20]),{c(){Ve(e.$$.fragment)},l(s){Me(e.$$.fragment,s)},m(s,n){ze(e,s,n),t=!0},p:ge,i(s){t||(he(e.$$.fragment,s),t=!0)},o(s){pe(e.$$.fragment,s),t=!1},d(s){Ie(e,s)}}}function Vs(i){let e,t;return e=new ys({}),e.$on("submit",i[23]),{c(){Ve(e.$$.fragment)},l(s){Me(e.$$.fragment,s)},m(s,n){ze(e,s,n),t=!0},p:ge,i(s){t||(he(e.$$.fragment,s),t=!0)},o(s){pe(e.$$.fragment,s),t=!1},d(s){Ie(e,s)}}}function js(i){let e,t,s,n;return{c(){e=v("div"),t=v("input"),this.h()},l(l){e=g(l,"DIV",{class:!0});var r=x(e);t=g(r,"INPUT",{type:!0,placeholder:!0,class:!0,style:!0}),r.forEach(b),this.h()},h(){u(t,"type","text"),u(t,"placeholder","Answer the question..."),u(t,"class","w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-gray-100 text-base focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"),Ye(t,"font-size","16px"),u(e,"class","relative")},m(l,r){re(l,e,r),c(e,t),Ge(t,i[6]),s||(n=[ae(t,"input",i[21]),ae(t,"keydown",i[22])],s=!0)},p(l,r){r[0]&64&&t.value!==l[6]&&Ge(t,l[6])},i:ge,o:ge,d(l){l&&b(e),s=!1,je(n)}}}function Ot(i){let e,t;return e=new ls({props:{options:i[4]}}),e.$on("select",i[14]),{c(){Ve(e.$$.fragment)},l(s){Me(e.$$.fragment,s)},m(s,n){ze(e,s,n),t=!0},p(s,n){const l={};n[0]&16&&(l.options=s[4]),e.$set(l)},i(s){t||(he(e.$$.fragment,s),t=!0)},o(s){pe(e.$$.fragment,s),t=!1},d(s){Ie(e,s)}}}function At(i){let e,t,s,n="âœ•",l,r,a,o,h;return r=new us({props:{characterName:i[12].name,level:i[12].level,experience:i[12].experience,nextLevelXP:i[12].nextLevelXP,strength:i[12].attributes.strength,dexterity:i[12].attributes.dexterity,constitution:i[12].attributes.constitution,intelligence:i[12].attributes.intelligence,wisdom:i[12].attributes.wisdom,charisma:i[12].attributes.charisma,skills:i[9]}}),{c(){e=v("div"),t=v("div"),s=v("button"),s.textContent=n,l=I(),Ve(r.$$.fragment),this.h()},l(d){e=g(d,"DIV",{class:!0,role:!0,tabindex:!0});var f=x(e);t=g(f,"DIV",{class:!0,role:!0,tabindex:!0});var m=x(t);s=g(m,"BUTTON",{class:!0,"data-testid":!0,"data-svelte-h":!0}),J(s)!=="svelte-y4cdky"&&(s.textContent=n),l=D(m),Me(r.$$.fragment,m),m.forEach(b),f.forEach(b),this.h()},h(){u(s,"class","absolute -top-2 -right-2 bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center text-white hover:bg-gray-600 z-10"),u(s,"data-testid","close-character-sheet"),u(t,"class","relative max-w-md w-full"),u(t,"role","document"),u(t,"tabindex","-1"),u(e,"class","absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50 transition-opacity"),u(e,"role","button"),u(e,"tabindex","0")},m(d,f){re(d,e,f),c(e,t),c(t,s),c(t,l),ze(r,t,null),a=!0,o||(h=[ae(s,"click",i[24]),ae(t,"click",ct(i[16])),ae(t,"keydown",ct(i[17])),ae(e,"click",i[25]),ae(e,"keydown",i[26])],o=!0)},p(d,f){const m={};f[0]&512&&(m.skills=d[9]),r.$set(m)},i(d){a||(he(r.$$.fragment,d),a=!0)},o(d){pe(r.$$.fragment,d),a=!1},d(d){d&&b(e),Ie(r),o=!1,je(h)}}}function Ps(i){let e,t,s,n="Thousand Worlds",l,r,a,o,h,d,f,m=i[7]?"Connected":"Reconnecting...",S,w,C,M,E,p,P="Logout",z,k,U,T,N,L,F,oe,K,ie,$,H,ve,A,Q=i[0]==="game"&&jt(i);function G(V,W){return V[0]==="checking"?Ms:V[0]==="interview"?zs:Is}let ne=G(i),X=ne(i),j=i[0]!=="interview"&&i[0]!=="checking"&&Bt(i);const ee=[js,Vs],Z=[];function Y(V,W){return V[0]==="interview"?0:V[0]!=="checking"?1:-1}~(L=Y(i))&&(F=Z[L]=ee[L](i));let q=i[3]&&i[4]&&Ot(i),O=i[8]&&At(i);return $=new vs({props:{isOpen:i[10],onClose:i[27],latestSimEvent:i[11]}}),{c(){e=v("div"),t=v("header"),s=v("h1"),s.textContent=n,l=I(),r=v("div"),a=v("div"),o=v("div"),d=I(),f=v("span"),S=se(m),M=I(),Q&&Q.c(),E=I(),p=v("button"),p.textContent=P,z=I(),k=v("main"),X.c(),U=I(),T=v("div"),j&&j.c(),N=I(),F&&F.c(),oe=I(),q&&q.c(),K=I(),O&&O.c(),ie=I(),Ve($.$$.fragment),this.h()},l(V){e=g(V,"DIV",{class:!0});var W=x(e);t=g(W,"HEADER",{class:!0});var ue=x(t);s=g(ue,"H1",{class:!0,"data-svelte-h":!0}),J(s)!=="svelte-1p9gpg2"&&(s.textContent=n),l=D(ue),r=g(ue,"DIV",{class:!0});var y=x(r);a=g(y,"DIV",{class:!0,title:!0});var _=x(a);o=g(_,"DIV",{class:!0}),x(o).forEach(b),d=D(_),f=g(_,"SPAN",{class:!0});var B=x(f);S=te(B,m),B.forEach(b),_.forEach(b),M=D(y),Q&&Q.l(y),E=D(y),p=g(y,"BUTTON",{class:!0,"data-svelte-h":!0}),J(p)!=="svelte-fhceqg"&&(p.textContent=P),y.forEach(b),ue.forEach(b),z=D(W),k=g(W,"MAIN",{class:!0});var R=x(k);X.l(R),U=D(R),T=g(R,"DIV",{class:!0});var ce=x(T);j&&j.l(ce),N=D(ce),F&&F.l(ce),ce.forEach(b),oe=D(R),q&&q.l(R),K=D(R),O&&O.l(R),ie=D(R),Me($.$$.fragment,R),R.forEach(b),W.forEach(b),this.h()},h(){u(s,"class","text-xl font-bold text-blue-400"),u(o,"class",h=Se(`w-3 h-3 rounded-full ${i[7]?"bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] connected":"bg-red-500 animate-pulse"}`)+" svelte-lcmnji"),u(f,"class",w=i[7]?"text-gray-400":"text-red-400"),u(a,"class","flex items-center gap-2 text-sm"),u(a,"title",C=i[7]?"Connected":"Disconnected"),u(p,"class","text-sm text-gray-400 hover:text-white transition-colors"),u(r,"class","flex items-center gap-4"),u(t,"class","bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center"),u(T,"class","p-4 bg-gray-800 border-t border-gray-700 space-y-3"),u(k,"class","flex-1 overflow-hidden flex flex-col relative"),u(e,"class","flex flex-col h-screen bg-gray-900 text-gray-100 font-mono")},m(V,W){re(V,e,W),c(e,t),c(t,s),c(t,l),c(t,r),c(r,a),c(a,o),c(a,d),c(a,f),c(f,S),c(r,M),Q&&Q.m(r,null),c(r,E),c(r,p),c(e,z),c(e,k),X.m(k,null),c(k,U),c(k,T),j&&j.m(T,null),c(T,N),~L&&Z[L].m(T,null),c(k,oe),q&&q.m(k,null),c(k,K),O&&O.m(k,null),c(k,ie),ze($,k,null),H=!0,ve||(A=ae(p,"click",i[19]),ve=!0)},p(V,W){(!H||W[0]&128&&h!==(h=Se(`w-3 h-3 rounded-full ${V[7]?"bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] connected":"bg-red-500 animate-pulse"}`)+" svelte-lcmnji"))&&u(o,"class",h),(!H||W[0]&128)&&m!==(m=V[7]?"Connected":"Reconnecting...")&&de(S,m),(!H||W[0]&128&&w!==(w=V[7]?"text-gray-400":"text-red-400"))&&u(f,"class",w),(!H||W[0]&128&&C!==(C=V[7]?"Connected":"Disconnected"))&&u(a,"title",C),V[0]==="game"?Q?Q.p(V,W):(Q=jt(V),Q.c(),Q.m(r,E)):Q&&(Q.d(1),Q=null),ne===(ne=G(V))&&X?X.p(V,W):(X.d(1),X=ne(V),X&&(X.c(),X.m(k,U))),V[0]!=="interview"&&V[0]!=="checking"?j?(j.p(V,W),W[0]&1&&he(j,1)):(j=Bt(V),j.c(),he(j,1),j.m(T,N)):j&&(Ae(),pe(j,1,1,()=>{j=null}),Re());let ue=L;L=Y(V),L===ue?~L&&Z[L].p(V,W):(F&&(Ae(),pe(Z[ue],1,1,()=>{Z[ue]=null}),Re()),~L?(F=Z[L],F?F.p(V,W):(F=Z[L]=ee[L](V),F.c()),he(F,1),F.m(T,null)):F=null),V[3]&&V[4]?q?(q.p(V,W),W[0]&24&&he(q,1)):(q=Ot(V),q.c(),he(q,1),q.m(k,K)):q&&(Ae(),pe(q,1,1,()=>{q=null}),Re()),V[8]?O?(O.p(V,W),W[0]&256&&he(O,1)):(O=At(V),O.c(),he(O,1),O.m(k,ie)):O&&(Ae(),pe(O,1,1,()=>{O=null}),Re());const y={};W[0]&1024&&(y.isOpen=V[10]),W[0]&1024&&(y.onClose=V[27]),W[0]&2048&&(y.latestSimEvent=V[11]),$.$set(y)},i(V){H||(he(j),he(F),he(q),he(O),he($.$$.fragment,V),H=!0)},o(V){pe(j),pe(F),pe(q),pe(O),pe($.$$.fragment,V),H=!1},d(V){V&&b(e),Q&&Q.d(),X.d(),j&&j.d(),~L&&Z[L].d(),q&&q.d(),O&&O.d(),Ie($),ve=!1,A()}}}const Be="/api";function Fs(i,e,t){let s="checking",n=null,l="",r="",a=[],o=!1,h=null,d=null,f=[],m="",S=null,w=!1,C=null,M=!1,E={},p={name:"Adventurer",level:1,experience:0,nextLevelXP:100,attributes:{strength:10,dexterity:10,constitution:10,intelligence:10,wisdom:10,charisma:10}},P=!1,z=null,k=null;tt(async()=>{try{k=await Ue.getMe()}catch{ht("/");return}const y=ke.connected.subscribe(B=>{t(7,w=B)});S=ke.onMessage(ve);const _=S;S=()=>{_&&_(),y()},await U()}),st(()=>{S&&S()});async function U(){try{const y=await fetch(`${Be}/world/interview/active`,{credentials:"include"});if(y.ok){const _=await y.json();if(_&&_.status==="in_progress"){if(t(0,s="interview"),n=_.session_id,_.question==="The interview is already complete."||_.question==="This interview is already complete."){A("system","World interview previously completed."),setTimeout(()=>{T()},1e3);return}if(t(2,a=_.conversation||[]),a.length>0){const B=a[a.length-1];B.role==="assistant"&&t(1,l=B.text)}else _.question&&(t(1,l=_.question),A("interview",l));A("system","Resuming your world creation interview...");return}}if(k!=null&&k.last_world_id)try{const _=await Ue.getCharacters();if(_&&_.characters){const B=_.characters.find(R=>R.world_id===(k==null?void 0:k.last_world_id));if(B){await $(B.character_id);return}}}catch(_){console.error("Auto-resume check failed",_)}await T()}catch(y){console.error("Onboarding check failed:",y),t(0,s="game"),A("error","Failed to check status. Starting in game mode."),T()}}async function T(){console.log("[Lobby] Joining lobby...");try{console.log("[Lobby] Disconnecting existing WebSocket..."),ke.disconnect(),await new Promise(y=>setTimeout(y,100)),console.log("[Lobby] Connecting to WebSocket..."),ke.connect(),t(0,s="lobby"),console.log("[Lobby] Lobby join complete")}catch(y){console.error("[Lobby] Failed to join lobby:",y),A("error","Failed to join lobby.")}}async function N(){try{const y=await fetch(`${Be}/world/interview/start`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});if(!y.ok){const B=await y.text();throw console.error("Interview start failed:",y.status,B),new Error(`Failed to start interview: ${y.status}`)}const _=await y.json();if(console.log("Interview started:",_),!_.session_id||!_.question)throw console.error("Invalid interview response:",_),new Error("Invalid response from server");n=_.session_id,t(1,l=_.question||"Tell me about the world you'd like to create."),a.push({role:"assistant",text:l}),A("interview",l),t(0,s="interview")}catch(y){console.error("Failed to start interview:",y),A("error",y.message||"Failed to start world interview. Please try again.")}}async function L(){if(!r.trim()||!n)return;const y=r.trim();a.push({role:"user",text:y}),A("user",y),r="";try{A("system","Thinking... (this may take 10-20 seconds)");const _=new AbortController,B=setTimeout(()=>_.abort(),6e4),R=await fetch(`${Be}/world/interview/message`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:n,message:y}),signal:_.signal});if(clearTimeout(B),!R.ok){const me=await R.text();throw console.error("Interview message failed:",R.status,me),new Error(`Failed to send message: ${R.status}`)}const ce=await R.json();if(console.log("Interview response:",ce),ce.completed||ce.question==="The interview is already complete."||ce.question==="This interview is already complete.")A("system","World interview complete! Creating your world..."),ce.question&&!ce.question.includes("already complete")&&(a.push({role:"assistant",text:ce.question}),A("interview",ce.question)),setTimeout(()=>{T(),A("system","World created! Use 'worlds' to see it.")},2e3);else{const me=ce.next_question||ce.question||ce.response||"Please continue...";t(1,l=me),a.push({role:"assistant",text:me}),A("interview",me)}}catch(_){console.error("Failed to send response:",_),A("error",_.message||"Failed to process your response. Please try again.")}}async function F(y){const _=y?y.trim():m.trim();if(_){if(A("player",`> ${_}`),s==="interview"){r=_,t(6,m=""),L();return}if(_.toLowerCase().startsWith("create character")){await H(_),y||t(6,m="");return}if(_.trim().toLowerCase()==="status"){Q(),y||t(6,m="");return}ke.sendCommandWithQueue(_),y||t(6,m="")}}async function oe(y){try{A("system",`Checking entry options for world ${y}...`);const _=await fetch(`${Be}/game/entry-options?world_id=${y}`,{credentials:"include"});if(_.ok){const B=await _.json();t(4,h=B),d=y,t(3,o=!0)}else{const B=await _.text();A("error",`Cannot enter world: ${B}`)}}catch{A("error","Failed to get entry options.")}}async function K(y){const{type:_,data:B}=y.detail;if(d){t(3,o=!1);try{if(_==="cancel"){d=null;return}if(_==="watcher"){await ie("Watcher","Spirit",d,"An invisible observer.","Watcher","watcher");return}if(_==="npc"){const R=B;await ie(R.name,R.species,d,R.description,R.occupation,"player",R.appearance)}_==="custom"&&(t(0,s="character"),A("system","Enter: create character <name> <species>"))}catch(R){console.error(R),A("error","Entry failed.")}}}async function ie(y,_,B,R,ce,me,_e){try{const we=await fetch(`${Be}/game/characters`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({world_id:B,name:y,species:_,role:me,description:R,occupation:ce,appearance:_e})});if(!we.ok){const xe=await we.json();let Pe="Failed to create character";throw typeof xe.error=="string"?Pe=xe.error:xe.error&&xe.error.message&&(Pe=xe.error.message),new Error(Pe)}const qe=await we.json();A("system",`Character "${y}" created! Joining world...`),await $(qe.character.character_id)}catch(we){A("error",we.message)}}async function $(y){try{const _=await fetch(`${Be}/game/join`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({character_id:y})});if(!_.ok){const R=await _.json();throw console.error("Failed to join game:",R),new Error("Failed to join game session.")}const B=await _.json();ke.disconnect(),ke.connect(y),C=y,t(0,s="game"),B.message?A("system",B.message):A("system","You have entered the world!")}catch(_){throw _}}async function H(y){const _=y.toLowerCase().split(" ");if(_[0]==="create"&&_[1]==="character"&&_.length>=4){const B=_[2],R=_[3].charAt(0).toUpperCase()+_[3].slice(1);await ie(B,R,d||"00000000-0000-0000-0000-000000000001")}else A("error","Invalid command. Use: create character <name> <species>")}function ve(y){var _;switch(y.type){case"game_message":const B=y.data.type;if(B==="trigger_entry_options"){const R=((_=y.data.metadata)==null?void 0:_.world_id)||y.data.text;oe(R)}else B==="start_interview"?N():A(B,y.data.text);break;case"error":A("error",y.data.message);break;case"sim_event":t(11,z=y),y.data.text&&y.data.text.includes("Simulation finished")&&(console.log("Simulation finished detected, opening map."),t(10,P=!0)),y.data.importance&&y.data.importance==="high"&&A("system",`[WORLD EVENT] ${y.data.description||y.data.text}`);break}}async function A(y,_){let B=!1;const R=document.getElementById("game-output");if(R){const{scrollTop:ce,scrollHeight:me,clientHeight:_e}=R;me-ce-_e<100&&(B=!0)}else B=!0;t(5,f=[...f,{id:Date.now().toString()+Math.random(),type:y,text:_,timestamp:new Date}]),await Yt(),B&&R&&(R.scrollTop=R.scrollHeight)}async function Q(){if(!C){A("error","No active character.");return}try{const y=await Ue.getSkills(C);t(9,E=y.skills||{}),t(8,M=!0)}catch(y){console.error(y),A("error","Failed to load skills.")}}function G(y){dt.call(this,i,y)}function ne(y){dt.call(this,i,y)}const X=()=>t(10,P=!0),j=()=>{Ue.logout(),ht("/")},ee=y=>F(y.detail);function Z(){m=this.value,t(6,m)}return[s,l,a,o,h,f,m,w,M,E,P,z,p,F,K,Q,G,ne,X,j,ee,Z,y=>y.key==="Enter"&&F(),y=>F(y.detail),()=>t(8,M=!1),()=>t(8,M=!1),y=>y.key==="Escape"&&t(8,M=!1),()=>t(10,P=!1)]}class Hs extends Ee{constructor(e){super(),Te(this,e,Fs,Ps,Ce,{},null,[-1,-1])}}export{Hs as component};
